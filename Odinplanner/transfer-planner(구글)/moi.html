<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ëª¨ì˜ê³ ì‚¬ DB</title>

<link id="themeLink" rel="stylesheet" href="">
<script src="trial.js"></script>
<script>
        // 1. trial.jsì—ì„œ ì €ì¥ëœ 'ìƒ‰ìƒ'ì„ ê°€ì ¸ì˜¤ê³ 
        const theme = getSavedTheme()|| "pink";
        // 2. ì´ í˜ì´ì§€ì˜ 'ì—­í• (check)'ì„ ì¡°í•©í•´ì„œ ê²½ë¡œ ì™„ì„±!
        const themePath = `${theme}/moi.css`; 
        document.getElementById("themeLink").href = themePath;
    </script>
</head>

<body>
<div class="container">

  <div class="note" onclick="location.href='index.html'">â† ë©”ì¸ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</div>

    <h1>ğŸ“ ëª¨ì˜ê³ ì‚¬ DB</h1>
  

  <div class="topbar">
    <button class="add-btn" onclick="addRow()">+ ìƒˆ ê¸°ë¡ ì¶”ê°€</button>
  </div>

  <div class="toggles">
    <!-- ê³¼ëª© í† ê¸€ -->
    <div class="pill" id="subjectPill">
      <button class="tab active" data-subject="ìˆ˜í•™">ìˆ˜í•™</button>
      <button class="tab" data-subject="ì˜ì–´">ì˜ì–´</button>
    </div>

    <!-- ê¸°ê°„ í† ê¸€ -->
    <div class="pill" id="periodPill">
      <button class="tab active" data-period="day">ì¼</button>
      <button class="tab" data-period="week">ì£¼</button>
      <button class="tab" data-period="month">ì›”</button>
    </div>

    <!-- ê¸°ì¤€ì¼ -->
    <div class="refdate">
      <label>ê¸°ì¤€ì¼</label>
      <input id="refDate" type="date" />
    </div>
  </div>

  <section class="summary">
    <div class="card">
      <div class="k">ğŸ“ˆ ê¸°ê°„ í‰ê·  ì ìˆ˜</div>
      <div class="v" id="avgScore">- <small>ì </small></div>
    </div>
    <div class="card">
      <div class="k">ğŸ… ìµœê³  ì ìˆ˜</div>
      <div class="v" id="bestScore">- <small>ì </small></div>
    </div>
  </section>

  <div style="display:flex; align-items:center; gap:10px; background:#fff; padding:10px; border-radius:10px; box-shadow:var(--shadow);">
  <span style="font-size:12px; font-weight:800; color:var(--pink-strong);">ğŸ“Š ëª¨ì˜ê³ ì‚¬ ëˆˆê¸ˆ:</span>
  <input type="number" id="mo-y-min" value="0" style="width:50px;"> ~ 
  <input type="number" id="mo-y-max" value="100" style="width:50px;">
  <button type="button" onclick="refreshAll()" style="background:var(--pink); color:#fff; border:none; padding:4px 10px; border-radius:5px; cursor:pointer;">ì ìš©</button>
</div>


  <section class="chart-card">
    <div class="chart-wrap">
      <canvas id="scoreChart"></canvas>
    </div>
  </section>

  <section class="table-card">
    <table>
      <thead>
        <tr>
          <th style="width:120px;">ê³¼ëª©</th>
          <th style="width:160px;">ì¼ì</th>
          <th style="width:120px;">ì ìˆ˜</th>
          <th style="width:140px;">ë°±ë¶„ìœ„</th>
          <th style="width:140px;">ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody id="mockBody"></tbody>
    </table>
  </section>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* =========================
   [0] ì €ì¥ í‚¤/ìƒíƒœ(ì „ì—­)
   ========================= */
const MOCK_KEY = "mockDB_records_v1";  // âœ… localStorage ì €ì¥ í‚¤
let currentSubject = "ìˆ˜í•™";           // âœ… ê³¼ëª© í† ê¸€ ìƒíƒœ
let currentPeriod  = "day";            // âœ… ê¸°ê°„ í† ê¸€ ìƒíƒœ(day/week/month)
let refDateISO = todayISO();           // âœ… ê¸°ì¤€ì¼(yyyy-mm-dd)
let records = loadRecords();           // âœ… ì „ì²´ ê¸°ë¡(JSON ë°°ì—´)

function getMockRowCount(){
  return document.querySelectorAll("#mockBody tr").length;
}

function guardMockLimit(){
  // ì²´í—˜ ì¤‘ì´ë©´ ì œí•œ ì—†ìŒ

  if (!isFullVersion){

    if (isTrialExpired()){
  // ì²´í—˜ ëë‚¬ìœ¼ë©´ 2ì¤„ê¹Œì§€ë§Œ í—ˆìš©
    if (getMockRowCount() >= 2){
      document.getElementById("lockBox").style.display = "flex";
      return false;
    }
  }
}
  return true;
}

/* =========================
   [1] ìœ í‹¸: ë‚ ì§œ ì²˜ë¦¬
   ========================= */
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function toDate(iso){ return new Date(iso + "T00:00:00"); } // âœ… ë¡œì»¬ ë‚ ì§œ ì•ˆì •í™”
function startOfWeek(d){ // âœ… ì£¼ ì‹œì‘(ì›”ìš”ì¼)
  const x = new Date(d);
  const day = (x.getDay()+6)%7; // ì¼(0) -> 6, ì›”(1)->0 ...
  x.setDate(x.getDate() - day);
  x.setHours(0,0,0,0);
  return x;
}
function endOfWeek(d){
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(e.getDate()+6);
  e.setHours(23,59,59,999);
  return e;
}
function startOfMonth(d){
  const x = new Date(d);
  x.setDate(1); x.setHours(0,0,0,0);
  return x;
}
function endOfMonth(d){
  const x = new Date(d);
  x.setMonth(x.getMonth()+1, 0);
  x.setHours(23,59,59,999);
  return x;
}
function inPeriod(dateISO){
  const d = toDate(dateISO);
  const ref = toDate(refDateISO);

  if(currentPeriod === "day"){
    return d.toDateString() === ref.toDateString();
  }
  if(currentPeriod === "week"){
    const s = startOfWeek(ref), e = endOfWeek(ref);
    return d >= s && d <= e;
  }
  // month
  const s = startOfMonth(ref), e = endOfMonth(ref);
  return d >= s && d <= e;
}

/* =========================
   [2] ì €ì¥/ë¡œë“œ(í•µì‹¬)
   ========================= */
function loadRecords(){
  try{
    const raw = localStorage.getItem(MOCK_KEY);
    if(!raw) return seed();               // âœ… ìµœì´ˆ ê¸°ë³¸ê°’
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : seed();
  }catch(e){
    return seed();
  }
}
function saveRecords(){
  localStorage.setItem(MOCK_KEY, JSON.stringify(records));
}

/* âœ… ìµœì´ˆ ë°ì´í„°(ì›í•˜ë©´ ë¹„ì›Œë„ ë¨) */
function seed(){
  return [
    { id: uid(), subject:"ìˆ˜í•™", date: todayISO(), score: 80, percentile: 85 },
    { id: uid(), subject:"ì˜ì–´", date: todayISO(), score: 78, percentile: 82 }
  ];
}
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

/* =========================
   [3] í•„í„°ë§(í† ê¸€ ê¸°ì¤€)
   ========================= */
function getFiltered(){
  return records
    .filter(r => r.subject === currentSubject)
    .filter(r => r.date && inPeriod(r.date))
    .sort((a,b)=> toDate(a.date) - toDate(b.date)); // âœ… ë‚ ì§œìˆœ ì •ë ¬
}

/* =========================
   [4] UI ë Œë”(í…Œì´ë¸”)
   ========================= */
const tbody = document.getElementById("mockBody");

function renderTable(){
  const list = getFiltered();
  tbody.innerHTML = list.map(r => rowHTML(r)).join("");

  // âœ… í–‰ ì´ë²¤íŠ¸ ì—°ê²°(ì…ë ¥ ë°”ë€Œë©´ ì¦‰ì‹œ records ìˆ˜ì • + ì €ì¥ + ê·¸ë˜í”„ì—…ë°ì´íŠ¸)
  tbody.querySelectorAll("tr").forEach(tr=>{
    const id = tr.getAttribute("data-id");

    const subSel = tr.querySelector(".subject");
    const dateIn = tr.querySelector(".date");
    const scoreTd = tr.querySelector(".score");
    const percTd  = tr.querySelector(".perc");
    const delBtn  = tr.querySelector(".del");

    subSel.addEventListener("change", ()=>{
      updateRecord(id, { subject: subSel.value });
    });

    dateIn.addEventListener("change", ()=>{
      updateRecord(id, { date: dateIn.value });
    });

    scoreTd.addEventListener("input", ()=>{
      updateRecord(id, { score: toNum(scoreTd.innerText) });
    });

    percTd.addEventListener("input", ()=>{
      updateRecord(id, { percentile: toNum(percTd.innerText) });
    });

    delBtn.addEventListener("click", ()=>{
      deleteRecord(id);
    });
  });
}

function rowHTML(r){
  return `
  <tr data-id="${r.id}">
    <td>
      <select class="subject">
        <option ${r.subject==="ìˆ˜í•™"?"selected":""}>ìˆ˜í•™</option>
        <option ${r.subject==="ì˜ì–´"?"selected":""}>ì˜ì–´</option>
      </select>
    </td>
    <td>
      <input class="date" type="date" value="${escapeAttr(r.date || todayISO())}" />
    </td>
    <td class="score" contenteditable="true">${escapeHTML(String(r.score ?? ""))}</td>
    <td class="perc" contenteditable="true">${escapeHTML(String(r.percentile ?? ""))}</td>
    <td>
      <div class="actions">
        <button class="icon-btn del" title="ì‚­ì œ">ğŸ—‘ï¸</button>
      </div>
    </td>
  </tr>`;
}
function escapeHTML(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHTML(s); }
function toNum(x){
  const n = parseFloat(String(x).replace(/[^\d.]/g,""));
  return Number.isFinite(n) ? n : null;
}

/* =========================
   [5] ë°ì´í„° ì¡°ì‘(ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ)
   ========================= */
function addRow(){

  const currentCount =
  records.filter(r => r.subject === currentSubject).length;

if(!isPaidUser){
  // âœ… ìƒˆ ì¤„ì€ í˜„ì¬ í† ê¸€ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì…ë ¥
  if (isTrialExpired() && currentCount >= 2){
      document.getElementById("lockBox").style.display = "flex";
      return;
    }
}
  records.push({
    id: uid(),
    subject: currentSubject,
    date: refDateISO,
    score: 0,
    percentile: 0
  });
  saveRecords();
  refreshAll();
}
function updateRecord(id, patch){
  const i = records.findIndex(r=>r.id===id);
  if(i<0) return;
  records[i] = { ...records[i], ...patch };
  saveRecords();
  refreshAccessStatus();
  refreshAll(false); // âœ… ì»¤ì„œ íŠ€ëŠ”ê±° ì‹«ìœ¼ë©´ í…Œì´ë¸” ì¬ë Œë”ëŠ” ìƒí™©ë”°ë¼ ì œì–´
}
function deleteRecord(id){
  records = records.filter(r=>r.id!==id);
  saveRecords();
  refreshAccessStatus();
  refreshAll();
}

/* =========================
   [6] ì°¨íŠ¸(ë‚ ì§œ xì¶•)
   ========================= */
let scoreChart;

function initChart(){
  const ctx = document.getElementById("scoreChart");
  scoreChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "ì ìˆ˜",
        data: [],
        tension: 0.25,
        fill: false
      }]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        tooltip:{
          callbacks:{
            label:(c)=> `${c.label}: ${c.raw}ì `
          }
        }
      },
      scales:{
        y:{
          suggestedMin:0,
          suggestedMax:100,
          ticks:{ stepSize:10 }
        }
      }
    }
  });
}

function updateChartAndSummary(){

  const yMin = Number(document.getElementById('mo-y-min')?.value) ?? 0;
  const yMax = Number(document.getElementById('mo-y-max')?.value) ?? 100;

  const list = getFiltered();
  const labels = list.map(r=>r.date);
  const values = list.map(r=>Number(r.score ?? 0));

  scoreChart.data.labels = labels;
  scoreChart.data.datasets[0].data = values;

  scoreChart.options.scales.y.min = yMin;
  scoreChart.options.scales.y.max = yMax;

  scoreChart.update();

  

  // âœ… ìš”ì•½(í‰ê· /ìµœê³ )
  if(values.length){
    const sum = values.reduce((a,b)=>a+b,0);
    const avg = Math.round(sum/values.length);
    const best = Math.max(...values);
    document.getElementById("avgScore").innerHTML  = `${avg} <small>ì </small>`;
    document.getElementById("bestScore").innerHTML = `${best} <small>ì </small>`;
  }else{
    document.getElementById("avgScore").innerHTML  = `- <small>ì </small>`;
    document.getElementById("bestScore").innerHTML = `- <small>ì </small>`;
  }
}

/* =========================
   [7] í† ê¸€/ê¸°ì¤€ì¼ ì´ë²¤íŠ¸
   ========================= */
function bindToggles(){
  // ê¸°ì¤€ì¼ ê¸°ë³¸ê°’ ì„¸íŒ…
  const refInput = document.getElementById("refDate");
  refInput.value = refDateISO;

  refInput.addEventListener("change", ()=>{
    refDateISO = refInput.value || todayISO();
    refreshAccessStatus();
    refreshAll();
  });

  // ê³¼ëª© í† ê¸€
  document.getElementById("subjectPill").addEventListener("click", (e)=>{
    const btn = e.target.closest(".tab");
    if(!btn) return;
    currentSubject = btn.dataset.subject;
    setActiveTabs("subjectPill", "subject", currentSubject);
    refreshAccessStatus();
    refreshAll();
  });

  // ê¸°ê°„ í† ê¸€
  document.getElementById("periodPill").addEventListener("click", (e)=>{
    const btn = e.target.closest(".tab");
    if(!btn) return;
    currentPeriod = btn.dataset.period;
    setActiveTabs("periodPill", "period", currentPeriod);
    refreshAccessStatus();
    refreshAll();
  });
}
function setActiveTabs(pillId, key, val){
  const pill = document.getElementById(pillId);
  pill.querySelectorAll(".tab").forEach(b=>{
    b.classList.toggle("active", b.dataset[key] === val);
  });
}

/* =========================
   [8] ì „ì²´ ìƒˆë¡œê³ ì¹¨(í‘œ+ì°¨íŠ¸)
   ========================= */
function refreshAll(rerenderTable=true){
  if(rerenderTable) renderTable();
  updateChartAndSummary();
}

/* =========================
   [9] ì‹œì‘(ì´ˆê¸°í™”)
   ========================= */
(function init(){
  // âœ… ê¸°ì¤€ì¼ ê¸°ë³¸: ì˜¤ëŠ˜
  refDateISO = todayISO();
  document.getElementById("refDate").value = refDateISO;

  // âœ… ì°¨íŠ¸ ë¨¼ì € ìƒì„±
  initChart();

  // âœ… í† ê¸€ ì´ë²¤íŠ¸ ì—°ê²°
  bindToggles();

  // âœ… ì²˜ìŒ ë Œë”
  refreshAll(true);
})();
</script>
<div id="lockBox">
  <div class="lock-inner">
    <div class="lock-icon">ğŸŒ¸</div>
    <h2>ì²´í—˜íŒ ë§Œë£Œ ì•Œë¦¼</h2>
    <p>ì‚¬ì¥ë‹˜ì˜ í”Œë˜ë„ˆë¥¼ ë¬´ì œí•œìœ¼ë¡œ ì´ìš©í•˜ë ¤ë©´<br>ì •ì‹ ë²„ì „ìœ¼ë¡œ ì „í™˜ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
    
    <button id="showInputBtn" onclick="handleAllPayments('transfer_planner.premium_upgrade')">í‰ìƒ ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    <button id="showInputBtn" onclick="handleAllPayments('transferplanner_monthly_purchase')">1ê°œì›” ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    <button id="showInputBtn" onclick="handleAllPayments('transferplanner_three_month_purchase')">3ê°œì›” ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    <button id="showInputBtn" onclick="handleAllPayments('transferplanner_six_month_purchase')">6ê°œì›” ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    
    <button class="btn-close" onclick="document.getElementById('lockBox').style.display='none'">ë‚˜ì¤‘ì— í• ê²Œìš”</button>
  </div>
</div>

</body>
</html>