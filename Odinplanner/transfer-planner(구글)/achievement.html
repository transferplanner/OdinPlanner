<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ† ì„±ì·¨ DB</title>
<link id="themeLink" rel="stylesheet" href="">
<script src="trial.js"></script>
<script>
        // 1. trial.jsì—ì„œ ì €ì¥ëœ 'ìƒ‰ìƒ'ì„ ê°€ì ¸ì˜¤ê³ 
        const theme = getSavedTheme()|| "pink";
        // 2. ì´ í˜ì´ì§€ì˜ 'ì—­í• (check)'ì„ ì¡°í•©í•´ì„œ ê²½ë¡œ ì™„ì„±!
        const themePath = `${theme}/achievement.css`; 
        document.getElementById("themeLink").href = themePath;
    </script>

</head>

<body>
<div class="container">

  <div class="back" onclick="location.href='index.html'">â† ë©”ì¸ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</div>

  <h1>ğŸ† ì„±ì·¨ DB</h1>

  <div class="topbar">
    <button class="btn" id="addTopBtn">+ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
  </div>

  <div class="summary">
    <div class="card">
      <div class="label">â±ï¸ ì˜¤ëŠ˜ ì´ ê³µë¶€ ì‹œê°„</div>
      <div class="value" id="studyTime">00:00:00</div>
      <div class="small">íŠ¸ë˜ì»¤ì™€ ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</div>
    </div>
    <div class="card">
      <div class="label">ğŸ¯ ëª©í‘œ ë‹¬ì„±ë¥ </div>
      <div class="value" id="overallProgress">0%</div>
      <div class="small">ìµœìƒìœ„ í•­ëª© í‰ê· </div>
    </div>
  </div>


  <div class ="section">
    <h2 class="section-title">ì˜¤ëŠ˜ í•  ì¼</h2>
    <div class="table-card">
    <table>
      <thead>
        <tr>
          <th style="width:60px">âœ…</th>
          <th style="width:42%">í•  ì¼</th>
          <th style="width:18%">ìƒíƒœ</th>
          <th style="width:18%">ê³¼ëª©</th>
          <th style="width:18%">ì§„í–‰ ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody id="todoBody"></tbody>
    </table>
  </div>
 </div>

 <!-- âœ… Habit Tracker Section -->
<div class="section-gap"></div>

<div class="table-card habit-card">
  <div class="habit-head">
    <div class="habit-title">âœ… í•´ë¹— íŠ¸ë˜ì»¤</div>
    <button class="btn" id="habitAddBtn" type="button">+ í•´ë¹— ì¶”ê°€</button>
  </div>

  <table class="habit-table">
    <thead>
      <tr>
        <th style="width:180px;">í•´ë¹—</th>
        <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th>
        <th style="width:80px;">ê´€ë¦¬</th>
      </tr>
    </thead>
    <tbody id="habitBody"></tbody>
  </table>

  <div class="habit-hint">â€» ì¹¸ì„ ëˆ„ë¥´ë©´ ì²´í¬ê°€ ì €ì¥ë¼. (ë¸Œë¼ìš°ì € ì €ì¥/localStorage)</div>
</div>

    </div>
  </div>
</div>

<script>
const KEY = "ACH_DB_V2_JSON";
const SUBJECTS = ["ê¸°íƒ€","ìˆ˜í•™","ì˜ì–´"];

let state = {
  items: [],
  nextId: 1
};

const tbody = document.getElementById("todoBody");
const overallEl = document.getElementById("overallProgress");
const studyTimeEl = document.getElementById("studyTime");

/* âœ… ì´ˆê¸°í™” í•¨ìˆ˜ */
function hardReset(){
  state = { items: [], nextId: 1 };
  localStorage.setItem(KEY, JSON.stringify(state));
  overallEl.textContent = "0%";
  const latestTime = localStorage.getItem('today_study_time') || "00:00:00";
  studyTimeEl.textContent = latestTime;
  tbody.innerHTML = "";
}

function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

/* âœ… ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ */
function load(){
  const saved = localStorage.getItem(KEY);
  if(saved) {
    state = JSON.parse(saved);
  } else {
    state = { items: [], nextId: 1 };
  }
}

function newId(){ return state.nextId++; }

function addTopItem(text="ìƒˆ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”", subject="ê¸°íƒ€", checked=false){
  const id = newId();
  const order = getChildren(null).length;
  state.items.push({ id, parentId:null, order, text, subject, checked });
  return id;
}

function addChildItem(parentId, text="í•˜ìœ„ í•  ì¼ ì…ë ¥", subject="ê¸°íƒ€", checked=false){
  const id = newId();
  const order = getChildren(parentId).length;
  state.items.push({ id, parentId, order, text, subject, checked });
  return id;
}

function getItem(id){ return state.items.find(x=>x.id===id); }

function getChildren(parentId){
  return state.items.filter(x=>x.parentId===parentId).sort((a,b)=>a.order-b.order);
}

function getDepth(item){
  let d=0, cur=item;
  while(cur && cur.parentId!=null){
    d++;
    cur = getItem(cur.parentId);
  }
  return d;
}

function getSubtreeIds(rootId){
  const out = [];
  (function dfs(id){
    out.push(id);
    getChildren(id).forEach(ch=>dfs(ch.id));
  })(rootId);
  return out;
}

function calcProgress(id){
  const children = getChildren(id);
  const item = getItem(id);
  if(!item) return 0;
  if(children.length===0) return item.checked ? 100 : 0;
  const done = children.filter(c=>c.checked).length;
  return Math.round((done / children.length) * 100);
}

function calcStatusByProgress(p){
  if(p>=100) return "done";
  if(p<=0) return "ready";
  return "doing";
}

function syncParentFromChildren(parentId){
  const p = calcProgress(parentId);
  const parent = getItem(parentId);
  if(!parent) return;
  if(getChildren(parentId).length > 0) parent.checked = (p === 100);
}

function updateOverall(){
  const tops = getChildren(null);
  if(!tops || tops.length === 0){
    overallEl.textContent = "0%";
    return;
  }
  let sum = 0;
  tops.forEach(t=> sum += calcProgress(t.id));
  overallEl.textContent = Math.round(sum / tops.length) + "%";
}

/* âœ… í™”ë©´ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì‹œê°„ ì—°ë™ ìˆ˜ì„  ì™„ë£Œ) */
function render(){
  tbody.innerHTML = "";
  const flat = [];
  function pushTree(parentId){
    getChildren(parentId).forEach(item=>{
      flat.push(item);
      pushTree(item.id);
    });
  }
  pushTree(null);

  flat.forEach(item=>{
    const tr = document.createElement("tr");
    tr.dataset.id = item.id;
    const depth = getDepth(item);
    const progress = calcProgress(item.id);
    const statusCls = calcStatusByProgress(progress);

    tr.innerHTML = `
      <td class="center"><input type="checkbox" class="cb" ${item.checked ? "checked":""}></td>
      <td>
        <div class="todo" style="padding-left:${depth*18}px;">
          <span class="arrow">â–¶</span>
          <span class="todo-text ${item.checked ? "completed":""}" contenteditable="true">${item.text}</span>
        </div>
      </td>
      <td><span class="status ${statusCls}">${statusText(statusCls)}</span></td>
      <td>${subjectSelectHTML(item.subject)}</td>
      <td class="progress">${progress}%</td>
    `;
    tbody.appendChild(tr);
  });

  updateOverall();
  
  // ğŸŒ¸ [ìˆ˜ì„  í¬ì¸íŠ¸] '00:00:00' ê³ ì •ê°’ì„ ì§€ìš°ê³ , ë©”ì¸ ì¥ë¶€ì—ì„œ ì‹œê°„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
  const latestTime = localStorage.getItem('today_study_time') || "00:00:00";
  studyTimeEl.textContent = latestTime;
}

function statusText(cls){
  return cls==="done" ? "ì™„ë£Œ" : (cls==="doing" ? "ì§„í–‰ ì¤‘" : "ì¤€ë¹„ ì¤‘");
}

function subjectSelectHTML(value){
  const opts = SUBJECTS.map(s=> `<option value="${s}" ${s===value?"selected":""}>${s}</option>`).join("");
  return `<select class="subject">${opts}</select>`;
}

document.getElementById("addTopBtn").addEventListener("click", ()=>{
  addTopItem();
  save();
  render();
});

tbody.addEventListener("click", (e)=>{
  const tr = e.target.closest("tr");
  if(!tr) return;
  if(e.target.classList.contains("arrow")){
    const id = Number(tr.dataset.id);
    addChildItem(id);
    syncParentFromChildren(id);
    bubbleUp(id);
    save();
    render();
  }
});

tbody.addEventListener("change", (e)=>{
  const tr = e.target.closest("tr");
  if(!tr) return;
  const id = Number(tr.dataset.id);

  if(e.target.classList.contains("cb")){
    const checked = e.target.checked;
    getSubtreeIds(id).forEach(sid=>{
      const it = getItem(sid);
      if(it) it.checked = checked;
    });
    bubbleUp(id);
    save();
    render();
  }

  if(e.target.classList.contains("subject")){
    const it = getItem(id);
    if(it){ it.subject = e.target.value; save(); render(); }
  }
});

tbody.addEventListener("input", (e)=>{
  const tr = e.target.closest("tr");
  if(!tr || !e.target.classList.contains("todo-text")) return;
  const it = getItem(Number(tr.dataset.id));
  if(it){ it.text = e.target.textContent; save(); }
});

function bubbleUp(fromId){
  let cur = getItem(fromId);
  while(cur && cur.parentId!=null){
    syncParentFromChildren(cur.parentId);
    cur = getItem(cur.parentId);
  }
}

/* âœ… ì‹¤í–‰ ë¶€ë¶„ */
window.addEventListener('DOMContentLoaded', () => {
  load();   // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  render(); // í™”ë©´ ê·¸ë¦¬ê¸° (ì—¬ê¸°ì„œ ì‹œê°„ë„ ê°€ì ¸ì™€ìš”!)
  bindHabitClicks();
  loadHabits();
});

</script>
<script>
/* =========================
   âœ… Habit Tracker (ì™„ì „íŒ)
   - ì›”~ì¼ 7ì¹¸ í† ê¸€
   - localStorage ì €ì¥/ë¡œë“œ
   - í•´ë¹— ì¶”ê°€/ì‚­ì œ
   - currentMajor(ìˆ˜í•™/ì˜ì–´)ë³„ë¡œ ë¶„ë¦¬ ì €ì¥
   ========================= */

(function(){
  // âœ… ë„¤ í˜ì´ì§€ì— currentMajor ìˆìœ¼ë©´ ê·¸ê±° ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ìˆ˜í•™
  function getMajor(){
    return (typeof window.currentMajor === "string" && window.currentMajor.trim())
      ? window.currentMajor.trim()
      : "ìˆ˜í•™";
  }

  const DAYS = ["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"];

  function key(){
    return `habit_v1:${getMajor()}`;
  }

  function load(){
    try{
      return JSON.parse(localStorage.getItem(key()) || "[]");
    }catch(e){
      return [];
    }
  }

  function save(data){
    localStorage.setItem(key(), JSON.stringify(data));
  }

  function ensureDefault(){
    const data = load();
    if(data.length) return;
    const seed = [
      { name:"ì˜ì–´ ë‹¨ì–´", checks:[false,false,false,false,false,false,false] },
      { name:"ê¸°ì¶œ 1ì„¸íŠ¸", checks:[false,false,false,false,false,false,false] },
    ];
    save(seed);
  }

  function render(){
    const tbody = document.getElementById("habitBody");
    if(!tbody) return;

    const data = load();
    tbody.innerHTML = "";

    data.forEach((row, idx) => {
      const tr = document.createElement("tr");

      // ì´ë¦„ ì…€
      const nameTd = document.createElement("td");
      nameTd.className = "habit-name";
      nameTd.contentEditable = "true";
      nameTd.innerText = row.name || "ìƒˆ í•´ë¹—";
      nameTd.addEventListener("input", () => {
        const d = load();
        if(!d[idx]) return;
        d[idx].name = nameTd.innerText.trim() || "ìƒˆ í•´ë¹—";
        save(d);
      });
      tr.appendChild(nameTd);

      // 7ì¹¸
      for(let i=0;i<7;i++){
        const td = document.createElement("td");
        td.className = "habit-cell" + (row.checks && row.checks[i] ? " checked" : "");
        td.dataset.row = String(idx);
        td.dataset.day = String(i);
        tr.appendChild(td);
      }

      // ì‚­ì œ
      const delTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.className = "habit-del";
      delBtn.type = "button";
      delBtn.innerText = "ì‚­ì œ";
      delBtn.addEventListener("click", () => {
        const d = load();
        d.splice(idx,1);
        save(d);
        render();
      });
      delTd.appendChild(delBtn);
      tr.appendChild(delTd);

      tbody.appendChild(tr);
    });
  }

  // âœ… ì´ë²¤íŠ¸ ìœ„ì„: ì¹¸ í´ë¦­ í† ê¸€
  function bind(){
    const tbody = document.getElementById("habitBody");
    if(!tbody) return;

    tbody.addEventListener("click", (e) => {
      const cell = e.target.closest(".habit-cell");
      if(!cell) return;

      const r = Number(cell.dataset.row);
      const d = Number(cell.dataset.day);

      const data = load();
      if(!data[r]) return;

      if(!Array.isArray(data[r].checks) || data[r].checks.length !== 7){
        data[r].checks = [false,false,false,false,false,false,false];
      }

      data[r].checks[d] = !data[r].checks[d];
      save(data);

      cell.classList.toggle("checked", data[r].checks[d]);
    });

    const addBtn = document.getElementById("habitAddBtn");
    if(addBtn){
      addBtn.addEventListener("click", () => {
        const data = load();
        data.push({ name:"ìƒˆ í•´ë¹—", checks:[false,false,false,false,false,false,false] });
        save(data);
        render();
      });
    }
  }

  // âœ… ì™¸ë¶€ì—ì„œ ê³¼ëª© í† ê¸€í•  ë•Œ ì¬ë Œë” í•„ìš”í•˜ë©´ ì´ í•¨ìˆ˜ë§Œ í˜¸ì¶œí•˜ë©´ ë¨
  window.renderHabit = function(){
    ensureDefault();
    render();
  };

  // ì´ˆê¸° ì‹¤í–‰
  ensureDefault();
  render();
  bind();

})();
</script>

</body>
</html>
