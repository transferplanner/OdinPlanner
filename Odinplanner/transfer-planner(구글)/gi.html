<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“˜ ê¸°ì¶œ DB (gi)</title>

<link id="themeLink" rel="stylesheet" href="">
<script src="trial.js"></script>
<script>
        // 1. trial.jsì—ì„œ ì €ì¥ëœ 'ìƒ‰ìƒ'ì„ ê°€ì ¸ì˜¤ê³ 
        const theme = getSavedTheme()|| "pink";
        // 2. ì´ í˜ì´ì§€ì˜ 'ì—­í• (check)'ì„ ì¡°í•©í•´ì„œ ê²½ë¡œ ì™„ì„±!
        const themePath = `${theme}/gi.css`; 
        document.getElementById("themeLink").href = themePath;
    </script>

</head>

<body>

<div class="container">

  <div class="back" onclick="location.href='index.html'">â† ë©”ì¸ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</div>

    <h1>ğŸ“˜ ê¸°ì¶œ DB</h1>
  

  <div class="topbar">
    <button class="add-btn" id="addBtn">+ ìƒˆ ê¸°ë¡ ì¶”ê°€</button>
    <div style="display:flex; align-items:center; gap:10px; background:#fff; padding:10px; border-radius:10px; box-shadow:var(--shadow);">
      <span style="font-size:12px; font-weight:800; color:var(--pink-strong);">ğŸ“Š ëˆˆê¸ˆ ì„¤ì •:</span>
      <input type="number" id="y-min" value="0"  placeholder="ìµœì†Œ" style="width:60px; padding:4px;">
      <span style="font-size:12px;">~</span>
      <input type="number" id="y-max" value="100"  placeholder="ìµœëŒ€" style="width:60px; padding:4px;">
      <button type="button" onclick="renderChart()" style="background:var(--pink-strong); color:#fff; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:900;">ì ìš©</button>
    </div>
  </div>

  <div class="toggles">
    <div class="pill" id="subjectPill">
      <button class="tab active" data-subject="ìˆ˜í•™">ìˆ˜í•™</button>
      <button class="tab" data-subject="ì˜ì–´">ì˜ì–´</button>
    </div>

    <div class="yearbox">
      <label>ë…„ë„</label>
      <select id="yearSelect"></select>
    </div>
  </div>

  <div class="chart-card">
    <canvas id="giChart"></canvas>
  </div>

  <div class="table-card">
    <table>
      <thead>
        <tr>
          <th style="width:110px;">ê³¼ëª©</th>
          <th style="width:110px;">ë…„ë„</th>
          <th style="width:260px;">í•™êµ</th>
          <th style="width:140px;">ì ìˆ˜</th>
          <th style="width:140px;">ë°±ë¶„ìœ„</th>
          <th style="width:90px;">ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="giBody"></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const SCHOOL_COLORS = {
  "ì„œìš¸ëŒ€": "#0b3c5d",
  "ì—°ì„¸ëŒ€": "#003876",
  "ê³ ë ¤ëŒ€": "#8c1d18",
  "ì„œê°•ëŒ€": "#c8102e",
  "ì„±ê· ê´€ëŒ€": "#8fc31f",
  "í•œì–‘ëŒ€": "#0f4c81",
  "ì¤‘ì•™ëŒ€": "#002b5c",
  "ê²½í¬ëŒ€": "#6a1b3f",
  "í•œêµ­ì™¸ëŒ€": "#00796b",
  "ì‹œë¦½ëŒ€": "#2b6cb0",
  "ì´í™”ì—¬ëŒ€": "#0b6f4e",
  "ê±´êµ­ëŒ€": "#1f4d2b",
  "ë™êµ­ëŒ€": "#e26a1f",
  "í™ìµëŒ€": "#7b1fa2",
  "ìˆ™ëª…ì—¬ëŒ€": "#1e5aa8",
  "êµ­ë¯¼ëŒ€": "#f5b400",
  "ìˆ­ì‹¤ëŒ€": "#006d6f",
  "ì„¸ì¢…ëŒ€": "#9e1b32"
  
};

const FALLBACK_PALETTE = [
  "#ff8fa3","#ffd6a5","#cdb4db","#a2d2ff","#bde0fe","#caffbf",
  "#9bf6ff","#ffc6ff","#fdffb6","#a0c4ff","#ffadad","#d0f4de",
  "#bdb2ff","#f1c0e8","#8ecae6","#219ebc","#023047","#fb8500"
];

const GI_KEY = "gi_db_v2";
let state = { subject: "ìˆ˜í•™", year: new Date().getFullYear() };
let db = [];

function uid(){
  return Math.random().toString(36).slice(2,10) + Date.now().toString(36);
}
function toNum(v){
  const n = Number(String(v).trim());
  return Number.isFinite(n) ? n : null;
}
function saveDB(){
  localStorage.setItem(GI_KEY, JSON.stringify({ state, db }));
}
function loadDB(){
  const raw = localStorage.getItem(GI_KEY);
  if(!raw) return false;
  try{
    const parsed = JSON.parse(raw);
    if(parsed?.db) db = parsed.db;
    if(parsed?.state) state = parsed.state;
    return true;
  }catch(e){
    console.warn("GI load fail:", e);
    return false;
  }
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normSchool(name){
  return String(name || "")
    .trim()
    .replace(/\s+/g, "")
    .replace(/ëŒ€í•™êµ$/,"ëŒ€")
    .replace("ëŒ€í•™êµ","ëŒ€");
}

function getSchoolColor(rawName, index){
  const key = normSchool(rawName);
  if(SCHOOL_COLORS[key]) return SCHOOL_COLORS[key];
  return FALLBACK_PALETTE[index % FALLBACK_PALETTE.length];
}

const tbody = document.getElementById("giBody");
const yearSelect = document.getElementById("yearSelect");
const addBtn = document.getElementById("addBtn");
const subjectPill = document.getElementById("subjectPill");

let chart = null;

function renderSubjectPill(){
  subjectPill.querySelectorAll(".tab").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.subject === state.subject);
  });
}

function renderYearOptions(){
  const years = new Set(db.map(x => x.year).filter(Boolean));
  years.add(new Date().getFullYear());
  const list = Array.from(years).sort((a,b)=>b-a);

  yearSelect.innerHTML = list.map(y => `<option value="${y}">${y}</option>`).join("");
  if(!list.includes(Number(state.year))) state.year = list[0] ?? new Date().getFullYear();
  yearSelect.value = String(state.year);
}

function renderTable(){
  const filtered = db.filter(x => x.subject === state.subject && x.year === Number(state.year));

  if(filtered.length === 0){
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="padding:18px;color:#777;font-weight:800;">
          ì•„ì§ ê¸°ë¡ì´ ì—†ì–´. â€œìƒˆ ê¸°ë¡ ì¶”ê°€â€ ëˆŒëŸ¬ì„œ ì‹œì‘í•˜ì.
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = filtered.map(row => `
    <tr data-id="${row.id}">
      <td>
        <select class="cell-subject small">
          <option ${row.subject==="ìˆ˜í•™"?"selected":""}>ìˆ˜í•™</option>
          <option ${row.subject==="ì˜ì–´"?"selected":""}>ì˜ì–´</option>
        </select>
      </td>
      <td>
  <select class="cell-year small">
    <option value="2026" ${row.year == 2026 ? 'selected' : ''}>2026</option>
    <option value="2025" ${row.year == 2025 ? 'selected' : ''}>2025</option>
    <option value="2024" ${row.year == 2024 ? 'selected' : ''}>2024</option>
    <option value="2023" ${row.year == 2023 ? 'selected' : ''}>2023</option>
    <option value="2022" ${row.year == 2022 ? 'selected' : ''}>2022</option>
    <option value="2021" ${row.year == 2021 ? 'selected' : ''}>2021</option>
    <option value="2020" ${row.year == 2020 ? 'selected' : ''}>2020</option>
    <option value="2019" ${row.year == 2019 ? 'selected' : ''}>2019</option>
    <option value="2018" ${row.year == 2018 ? 'selected' : ''}>2018</option>
    <option value="2017" ${row.year == 2017 ? 'selected' : ''}>2017</option>
    <option value="2016" ${row.year == 2016 ? 'selected' : ''}>2016</option>
    <option value="2015" ${row.year == 2015 ? 'selected' : ''}>2015</option>
  </select>
</td>

      <td>
        <input class="cell-school school" type="text"
          value="${escapeHtml(row.school ?? "")}"
          placeholder="ì˜ˆ: ê±´êµ­ëŒ€ / ì„œê°•ëŒ€í•™êµë„ ê°€ëŠ¥"/>
      </td>
      <td>
        <input class="cell-score small" type="number" min="0" max="100" step="0.1"
          value="${row.score ?? ""}" placeholder="ì˜ˆ: 85"/>
      </td>
      <td>
        <input class="cell-per small" type="number" min="0" max="100" step="0.1"
          value="${row.percentile ?? ""}" placeholder="ì˜ˆ: 92"/>
      </td>
      <td><button class="del-btn">ì‚­ì œ</button></td>
    </tr>
  `).join("");
}

function renderChart(){
  const yMin = Number(document.getElementById('y-min').value) || 0;
  const yMax = Number(document.getElementById('y-max').value) || 100;

  const filtered = db
    .filter(x => x.subject === state.subject && x.year === Number(state.year))
    .filter(x => x.school && x.score !== null && x.score !== undefined);

  const bySchool = new Map();
  filtered.forEach(x => bySchool.set(normSchool(x.school), x.score));

  const labels = Array.from(bySchool.keys());
  const data   = labels.map(k => bySchool.get(k));
  const colors = labels.map((school, i) => getSchoolColor(school, i));

  if(!chart){
    chart = new Chart(document.getElementById("giChart"), {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: `${state.subject} ê¸°ì¶œ ì ìˆ˜ (${state.year})`,
          data,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { min: yMin, max: yMax }
        },
        plugins: {
          tooltip: {
            callbacks: { label: (ctx) => `${ctx.label}: ${ctx.raw}` }
          },
          legend: { display: true }
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].label = `${state.subject} ê¸°ì¶œ ì ìˆ˜ (${state.year})`;
    chart.data.datasets[0].data = data;
    chart.data.datasets[0].backgroundColor = colors;
    // ì°¨íŠ¸ ëˆˆê¸ˆ ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€
    chart.options.scales.y.min = yMin;
    chart.options.scales.y.max = yMax;
    chart.update();
  }
}

function refreshAll(){
  renderSubjectPill();
  renderYearOptions();
  renderTable();
  renderChart();
  refreshAccessStatus();
  saveDB();
}

function addRow(){

  if(!isPaidUser){

    if (isTrialExpired()){
      const currentCount = db.filter(x =>
        x.subject === state.subject && x.year === Number(state.year)
      ).length;

      if (currentCount >= 2){
        const lock = document.getElementById("lockBox");
        if (lock) lock.style.display = "flex";
        return;
      }
    }
  }

  db.push({
    id: uid(),
    subject: state.subject,
    year: Number(state.year),
    school: "",
    score: null,
    percentile: null
  });
  refreshAccessStatus();
  refreshAll();
}
addBtn.addEventListener("click", addRow);

subjectPill.addEventListener("click", (ev)=>{
  const btn = ev.target.closest(".tab");
  if(!btn) return;
  state.subject = btn.dataset.subject;
  refreshAccessStatus();
  refreshAll();
});

yearSelect.addEventListener("change", ()=>{
  state.year = Number(yearSelect.value);
  refreshAccessStatus();
  refreshAll();
});

tbody.addEventListener("change", (ev)=>{
  const tr = ev.target.closest("tr");
  if(!tr) return;
  const id = tr.dataset.id;
  const item = db.find(x => x.id === id);
  if(!item) return;

  if(ev.target.classList.contains("cell-year")){
    item.year = toNum(ev.target.value) ?? item.year;
  }
  if(ev.target.classList.contains("cell-school")){
    item.school = ev.target.value;
  }
  if(ev.target.classList.contains("cell-score")){
    item.score = toNum(ev.target.value);
  }
  if(ev.target.classList.contains("cell-per")){
    item.percentile = toNum(ev.target.value);
  }
  refreshAccessStatus();
  refreshAll();
});

tbody.addEventListener("change", (ev)=>{
  const tr = ev.target.closest("tr");
  if(!tr) return;
  const id = tr.dataset.id;
  const item = db.find(x => x.id === id);
  if(!item) return;

  if(ev.target.classList.contains("cell-subject")){
    item.subject = ev.target.value;
    refreshAccessStatus();
    refreshAll();
  }
});

tbody.addEventListener("click", (ev)=>{
  if(!ev.target.classList.contains("del-btn")) return;
  const tr = ev.target.closest("tr");
  if(!tr) return;
  const id = tr.dataset.id;
  db = db.filter(x => x.id !== id);
  refreshAccessStatus();
  refreshAll();
});

(function init(){
  const ok = loadDB();
  state.year = Number(state.year) || new Date().getFullYear();

  if(!ok){
    db = [
      { id: uid(), subject:"ìˆ˜í•™", year: state.year, school:"ê±´êµ­ëŒ€", score:85, percentile:null },
      { id: uid(), subject:"ìˆ˜í•™", year: state.year, school:"ì„œê°•ëŒ€", score:97, percentile:null },
      { id: uid(), subject:"ìˆ˜í•™", year: state.year, school:"ì„±ê· ê´€ëŒ€", score:96.2, percentile:null },
      { id: uid(), subject:"ì˜ì–´", year: state.year, school:"ì‹œë¦½ëŒ€", score:93, percentile:null }
    ];
  }

  refreshAccessStatus();
  refreshAll();
})();
</script>
<div id="lockBox">
  <div class="lock-inner">
    <div class="lock-icon">ğŸŒ¸</div>
    <h2>ì²´í—˜íŒ ë§Œë£Œ ì•Œë¦¼</h2>
    <p>ì‚¬ì¥ë‹˜ì˜ í”Œë˜ë„ˆë¥¼ ë¬´ì œí•œìœ¼ë¡œ ì´ìš©í•˜ë ¤ë©´<br>ì •ì‹ ë²„ì „ìœ¼ë¡œ ì „í™˜ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
    
    <button id="showInputBtn" onclick="handleAllPayments('transfer_planner.premium_upgrade')">í‰ìƒ ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    <button id="showInputBtn" onclick="handleAllPayments('transferplanner_monthly_purchase')">1ê°œì›” ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    <button id="showInputBtn" onclick="handleAllPayments('transferplanner_three_month_purchase')">3ê°œì›” ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    <button id="showInputBtn" onclick="handleAllPayments('transferplanner_six_month_purchase')">6ê°œì›” ì´ìš©ê¶Œ ê²°ì œí•˜ê¸° ğŸŒ¸</button>
    
    <button class="btn-close" onclick="document.getElementById('lockBox').style.display='none'">ë‚˜ì¤‘ì— í• ê²Œìš”</button>
  </div>
</div>
</body>
</html>
